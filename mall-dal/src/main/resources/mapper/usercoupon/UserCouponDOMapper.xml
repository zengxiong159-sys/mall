<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qdbank.mall.mapper.usercoupon.UserCouponDOMapper">
  <resultMap id="BaseResultMap" type="com.qdbank.mall.model.usercoupon.UserCouponDO">
    <result column="USER_COUPON_ID" jdbcType="DECIMAL" property="userCouponId" />
    <result column="COUPON_TYPE" jdbcType="DECIMAL" property="couponType" />
    <result column="ORDER_SN" jdbcType="VARCHAR" property="orderSn" />
    <result column="CUST_NO" jdbcType="VARCHAR" property="custNo" />
    <result column="COUPON_ID" jdbcType="DECIMAL" property="couponId" />
    <result column="BATCH_NO" jdbcType="VARCHAR" property="batchNo" />
    <result column="ORDER_INTEGRATION" jdbcType="DECIMAL" property="orderIntegration" />
    <result column="COUPON_NAME" jdbcType="VARCHAR" property="couponName" />
    <result column="STATUS" jdbcType="DECIMAL" property="status" />
    <result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
    <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="EXPIRE_DATE" jdbcType="TIMESTAMP" property="expireDate" />
  </resultMap>
  <sql id="Example_Where_Clause">
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    USER_COUPON_ID, COUPON_TYPE, ORDER_SN, CUST_NO, COUPON_ID, BATCH_NO, ORDER_INTEGRATION, 
    COUPON_NAME, STATUS, CREATE_TIME, UPDATE_TIME,EXPIRE_DATE
  </sql>
  <select id="selectByExample" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDOExample" resultMap="BaseResultMap">
    select
    <if test="distinct">
      distinct
    </if>
    'true' as QUERYID,
    <include refid="Base_Column_List" />
    from SMS_USER_COUPON
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <delete id="deleteByExample" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDOExample">
    delete from SMS_USER_COUPON
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    insert into SMS_USER_COUPON (USER_COUPON_ID, COUPON_TYPE, ORDER_SN, 
      CUST_NO, COUPON_ID, BATCH_NO, 
      ORDER_INTEGRATION, COUPON_NAME, STATUS, 
      CREATE_TIME, UPDATE_TIME,EXPIRE_DATE)
    values (#{userCouponId,jdbcType=DECIMAL}, #{couponType,jdbcType=DECIMAL}, #{orderSn,jdbcType=VARCHAR}, 
      #{custNo,jdbcType=VARCHAR}, #{couponId,jdbcType=DECIMAL}, #{batchNo,jdbcType=VARCHAR}, 
      #{orderIntegration,jdbcType=DECIMAL}, #{couponName,jdbcType=VARCHAR}, #{status,jdbcType=DECIMAL}, 
      #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP},#{expireDate,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    insert into SMS_USER_COUPON
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="userCouponId != null">
        USER_COUPON_ID,
      </if>
      <if test="couponType != null">
        COUPON_TYPE,
      </if>
      <if test="orderSn != null">
        ORDER_SN,
      </if>
      <if test="custNo != null">
        CUST_NO,
      </if>
      <if test="couponId != null">
        COUPON_ID,
      </if>
      <if test="batchNo != null">
        BATCH_NO,
      </if>
      <if test="orderIntegration != null">
        ORDER_INTEGRATION,
      </if>
      <if test="couponName != null">
        COUPON_NAME,
      </if>
      <if test="status != null">
        STATUS,
      </if>
      <if test="createTime != null">
        CREATE_TIME,
      </if>
      <if test="updateTime != null">
        UPDATE_TIME,
      </if>
      <if test="expireDate != null">
        EXPIRE_DATE,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="userCouponId != null">
        #{userCouponId,jdbcType=DECIMAL},
      </if>
      <if test="couponType != null">
        #{couponType,jdbcType=DECIMAL},
      </if>
      <if test="orderSn != null">
        #{orderSn,jdbcType=VARCHAR},
      </if>
      <if test="custNo != null">
        #{custNo,jdbcType=VARCHAR},
      </if>
      <if test="couponId != null">
        #{couponId,jdbcType=DECIMAL},
      </if>
      <if test="batchNo != null">
        #{batchNo,jdbcType=VARCHAR},
      </if>
      <if test="orderIntegration != null">
        #{orderIntegration,jdbcType=DECIMAL},
      </if>
      <if test="couponName != null">
        #{couponName,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=DECIMAL},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="expireDate != null">
        #{expireDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDOExample" resultType="java.lang.Long">
    select count(*) from SMS_USER_COUPON
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    update SMS_USER_COUPON
    <set>
      <if test="record.userCouponId != null">
        USER_COUPON_ID = #{record.userCouponId,jdbcType=DECIMAL},
      </if>
      <if test="record.couponType != null">
        COUPON_TYPE = #{record.couponType,jdbcType=DECIMAL},
      </if>
      <if test="record.orderSn != null">
        ORDER_SN = #{record.orderSn,jdbcType=VARCHAR},
      </if>
      <if test="record.custNo != null">
        CUST_NO = #{record.custNo,jdbcType=VARCHAR},
      </if>
      <if test="record.couponId != null">
        COUPON_ID = #{record.couponId,jdbcType=DECIMAL},
      </if>
      <if test="record.batchNo != null">
        BATCH_NO = #{record.batchNo,jdbcType=VARCHAR},
      </if>
      <if test="record.orderIntegration != null">
        ORDER_INTEGRATION = #{record.orderIntegration,jdbcType=DECIMAL},
      </if>
      <if test="record.couponName != null">
        COUPON_NAME = #{record.couponName,jdbcType=VARCHAR},
      </if>
      <if test="record.status != null">
        STATUS = #{record.status,jdbcType=DECIMAL},
      </if>
      <if test="record.createTime != null">
        CREATE_TIME = #{record.createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.updateTime != null">
        UPDATE_TIME = #{record.updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.expireDate != null">
        EXPIRE_DATE = #{record.expireDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    update SMS_USER_COUPON
    set USER_COUPON_ID = #{record.userCouponId,jdbcType=DECIMAL},
      COUPON_TYPE = #{record.couponType,jdbcType=DECIMAL},
      ORDER_SN = #{record.orderSn,jdbcType=VARCHAR},
      CUST_NO = #{record.custNo,jdbcType=VARCHAR},
      COUPON_ID = #{record.couponId,jdbcType=DECIMAL},
      BATCH_NO = #{record.batchNo,jdbcType=VARCHAR},
      ORDER_INTEGRATION = #{record.orderIntegration,jdbcType=DECIMAL},
      COUPON_NAME = #{record.couponName,jdbcType=VARCHAR},
      STATUS = #{record.status,jdbcType=DECIMAL},
      CREATE_TIME = #{record.createTime,jdbcType=TIMESTAMP},
      UPDATE_TIME = #{record.updateTime,jdbcType=TIMESTAMP},
        EXPIRE_DATE = #{record.expireDate,jdbcType=TIMESTAMP}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <insert id="batchInsertCoupon" parameterType="java.util.ArrayList" useGeneratedKeys="false">
    INSERT ALL
    <foreach item="item" index="index" collection="list">
      into SMS_USER_COUPON (USER_COUPON_ID, COUPON_TYPE, ORDER_SN,
      CUST_NO, COUPON_ID, BATCH_NO,
      ORDER_INTEGRATION,  STATUS,
      CREATE_TIME, UPDATE_TIME,COUPON_NAME,EXPIRE_DATE)
      values (#{item.userCouponId,jdbcType=DECIMAL}, #{item.couponType,jdbcType=DECIMAL}, #{item.orderSn,jdbcType=VARCHAR},
      #{item.custNo,jdbcType=VARCHAR}, #{item.couponId,jdbcType=DECIMAL}, #{item.batchNo,jdbcType=VARCHAR},
      #{item.orderIntegration,jdbcType=DECIMAL}, #{item.status,jdbcType=DECIMAL},
      #{item.createTime,jdbcType=TIMESTAMP}, #{item.updateTime,jdbcType=TIMESTAMP},#{item.couponName,jdbcType=VARCHAR},#{item.expireDate,jdbcType=TIMESTAMP})
    </foreach>
    SELECT 1 FROM DUAL
  </insert>
  <resultMap id="ExportResultMap" type="com.qdbank.mall.model.usercoupon.ExportUserCouponDO">
    <result column="USER_COUPON_ID" jdbcType="DECIMAL" property="userCouponId" />
    <result column="couponTypeValue" jdbcType="VARCHAR" property="couponTypeValue" />
    <result column="ORDER_SN" jdbcType="VARCHAR" property="orderSn" />
    <result column="CUST_NO" jdbcType="VARCHAR" property="custNo" />
    <result column="USER_COUPON_ID" jdbcType="DECIMAL" property="userCouponId" />
    <result column="BATCH_NO" jdbcType="VARCHAR" property="batchNo" />
    <result column="coupon_amount" jdbcType="DECIMAL" property="couponAmount" />
    <result column="COUPON_NAME" jdbcType="VARCHAR" property="couponName" />
    <result column="statusValue" jdbcType="VARCHAR" property="statusValue" />
    <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="product_id" jdbcType="DECIMAL" property="productId"></result>
    <result column="product_name" jdbcType="VARCHAR" property="productName"></result>
    <result column="send_time" jdbcType="TIMESTAMP" property="sendTime"/>
    <result column="product_id" jdbcType="DECIMAL" property="productId"></result>
    <result column="exchange_coupon_id" jdbcType="DECIMAL" property="relCouponId"></result>
    <result column="prefecture_id" jdbcType="DECIMAL" property="prefectureId"></result>
    <result column="coupon_type" jdbcType="DECIMAL" property="couponType"></result>
    <result column="sub_activity_id" jdbcType="VARCHAR" property="subActivityId"></result>
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
  </resultMap>
<select id="selectCouponDOByBatchNo" parameterType="java.lang.String" resultMap="ExportResultMap">
   select
    u.CUST_NO ,
    u.BATCH_NO ,
    case
    when u.STATUS = 1 then '已使用'
    when u.STATUS = 0 then '待使用'
    when u.STATUS = -1 then '待发放'
    when u.STATUS = 2 then '已过期'
    when u.STATUS = 3 then '已作废'
    when u.STATUS = 4 then '待生效'
    when u.STATUS = 5 then '已生效'
    else '已失效'
    end  as statusValue,
    case
    when u.coupon_type = 0 then '积分兑换券'
    when u.coupon_type = 1 then '指定商品免费兑换券'
    when u.coupon_type = 2 then '指定商品现金优惠券'
    else '指定专区现金优惠券'
    end as couponTypeValue,
    u.USER_COUPON_ID ,
    s.coupon_name ,
    s.coupon_amount ,
    s.send_time,
    u.update_time ,
    u.order_sn,
    s.product_id,
    s.product_name,
    s.exchange_coupon_id,
    s.prefecture_id,
    u.coupon_type ,
    s.sub_activity_id,
    u.create_time
   from
   SMS_USER_COUPON u,SMS_COUPON s
   where
   u.BATCH_NO = s.BATCH_NO
   and
   u.BATCH_NO = #{batchNo,jdbcType=VARCHAR}
</select>

  <delete id="deleteByBatchNo" parameterType="java.lang.String">
    delete from SMS_USER_COUPON
    where BATCH_NO = #{batchNo}
  </delete>

  <update id="updateStatus" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
        update SMS_USER_COUPON set status = #{status,jdbcType=DECIMAL},
         UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP}
         where COUPON_ID = #{couponId,jdbcType=DECIMAL} and status != 1
  </update>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    delete from SMS_USER_COUPON
    where USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
  </delete>

  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from SMS_USER_COUPON
    where USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
  </select>

  <update id="updateByPrimaryKeySelective" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    update SMS_USER_COUPON
    <set>
      <if test="couponType != null">
        COUPON_TYPE = #{couponType,jdbcType=DECIMAL},
      </if>
      <if test="orderSn != null">
        ORDER_SN = #{orderSn,jdbcType=VARCHAR},
      </if>
      <if test="custNo != null">
        CUST_NO = #{custNo,jdbcType=VARCHAR},
      </if>
      <if test="couponId != null">
        COUPON_ID = #{couponId,jdbcType=DECIMAL},
      </if>
      <if test="batchNo != null">
        BATCH_NO = #{batchNo,jdbcType=VARCHAR},
      </if>
      <if test="orderIntegration != null">
        ORDER_INTEGRATION = #{orderIntegration,jdbcType=DECIMAL},
      </if>
      <if test="couponName != null">
        COUPON_NAME = #{couponName,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        STATUS = #{status,jdbcType=DECIMAL},
      </if>
      <if test="createTime != null">
        CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="expireDate != null">
        EXPIRE_DATE = #{expireDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    update SMS_USER_COUPON
    set COUPON_TYPE = #{couponType,jdbcType=DECIMAL},
      ORDER_SN = #{orderSn,jdbcType=VARCHAR},
      CUST_NO = #{custNo,jdbcType=VARCHAR},
      COUPON_ID = #{couponId,jdbcType=DECIMAL},
      BATCH_NO = #{batchNo,jdbcType=VARCHAR},
      ORDER_INTEGRATION = #{orderIntegration,jdbcType=DECIMAL},
      COUPON_NAME = #{couponName,jdbcType=VARCHAR},
      STATUS = #{status,jdbcType=DECIMAL},
      CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
      UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP},
      EXPIRE_DATE = #{expireDate,jdbcType=TIMESTAMP}
    where USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
  </update>


<!-- mall front -->
  <resultMap id="couponResultMap" type="com.qdbank.mall.model.usercoupon.UserCouponDetailDO" extends="BaseResultMap">
    <result column="PRODUCT_INTEGRATION" jdbcType="DECIMAL" property="productIntegration" />
    <result column="COUPON_AMOUNT" jdbcType="DECIMAL" property="couponAmount" />
    <result column="COUPON_DESCRIPTION" jdbcType="VARCHAR" property="couponDescription" />
    <result column="PRODUCT_STATUS" jdbcType="DECIMAL" property="productStatus" />
    <result column="BATCH_STATUS" jdbcType="DECIMAL" property="batchStatus" />
    <result column="PRODUCT_TYPE" jdbcType="DECIMAL" property="productType" />
    <result column="PRODUCT_ID" jdbcType="DECIMAL" property="productId" />
    <result column="PRODUCT_NAME" jdbcType="VARCHAR" property="productName" />
    <result column="PRODUCT_SKU_ID" jdbcType="DECIMAL" property="productSkuId" />
    <result column="EXPIRE_DAYS" jdbcType="DECIMAL" property="expireDays" />
    <result column="EXPIRE_DATE" jdbcType="TIMESTAMP" property="expireDate" />
    <result column="SEND_TIME" jdbcType="TIMESTAMP" property="sendTime" />
    <result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
    <result column="PREFECTURE_ID" jdbcType="DECIMAL" property="prefectureId" />
    <result column="MAIN_ACTIVITY_ID" jdbcType="VARCHAR" property="mainActivityId" />
    <result column="SUB_ACTIVITY_ID" jdbcType="VARCHAR" property="subActivityId" />
    <result column="DISTRIBUTE_WAY" jdbcType="DECIMAL" property="distributeWay" />
    <result column="START_TIME" jdbcType="TIMESTAMP" property="startTime" />
    <result column="END_TIME" jdbcType="TIMESTAMP" property="endTime" />
  </resultMap>

  <select id="qryCouponDetail"  resultMap="couponResultMap">
   select
    s.product_integration,
    s.coupon_amount,
    s.coupon_description,
    s.product_status,
    s.batch_status,
    s.product_type,
    s.product_id,
    s.product_name,
    s.product_sku_id,
    s.expire_days,
    s.prefecture_id,
    s.main_activity_id,
    s.sub_activity_id,
    u.expire_date,
    s.send_time,
    u.user_coupon_id,
    u.coupon_type,
    u.order_sn,
    u.coupon_id,
    u.order_integration,
    s.coupon_name,
    u.status,
    u.batch_no,
    s.distribute_way,
    s.start_time,
    s.end_time,
    u.create_time
    from
   SMS_USER_COUPON u,SMS_COUPON s
   where
   u.COUPON_ID = s.COUPON_ID
    <if test="userCouponStatus != null">
      and u.STATUS = #{userCouponStatus,jdbcType=DECIMAL}
    </if>
    <if test="custNo != null and custNo!=''">
      and u.CUST_NO = #{custNo,jdbcType=VARCHAR}
    </if>
    <if test="userCouponId != null">
      and u.USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
    </if>
    <if test="productId != null">
      and s.PRODUCT_ID = #{productId,jdbcType=DECIMAL}
    </if>
    <if test="productSkuId != null">
      and s.PRODUCT_SKU_ID = #{productSkuId,jdbcType=DECIMAL}
    </if>
    order by nvl(u.expire_date,s.end_time)
</select>

  <update id="updateProductCouponExpireStatus" parameterType="java.util.List">
    <foreach collection="list" item="item" index="index"  open="begin" close=";end;" separator=";">
      update SMS_USER_COUPON t
      <set>
        t.STATUS = 2,
        t.UPDATE_TIME = sysdate
      </set>
      WHERE
        t.BATCH_NO = #{item,jdbcType=VARCHAR}
      AND
        t.STATUS = 0
    </foreach>
  </update>

  <update id="updateIntegrationCouponExpireStatus">
    update
        SMS_USER_COUPON t
    set
        t.STATUS = 2,
        t.UPDATE_TIME = sysdate
    where
        t.COUPON_TYPE = 0
    and
        t.STATUS = 0
    and
        t.expire_date &lt; #{endDate,jdbcType=TIMESTAMP}
    and
        t.expire_date &gt; #{startDate,jdbcType=TIMESTAMP}
  </update>
  
  <select id="selectExpireOrderSN" resultType="java.lang.String">
    select
        order_sn
    from
         SMS_USER_COUPON t
    where
        t.COUPON_TYPE = 0
    and
        t.STATUS = 0
    and
        t.expire_date &lt; #{endDate,jdbcType=TIMESTAMP}
    and
        t.expire_date &gt; #{startDate,jdbcType=TIMESTAMP}
  </select>

  <!-- 根据批次号查询指定批次已使用和已过期数量 -->
  <select id="selectCountByCouponId" resultType="java.util.HashMap">
    select
        count(1) as quantity,
        status as status
    from
        SMS_USER_COUPON
    <where>
      STATUS in(1,2)
      <if test="couponId != null">
        and COUPON_ID = #{couponId,jdbcType=DECIMAL}
      </if>
      <choose>
        <when test="isBatch">
          and BATCH_NO is not null
        </when>
        <otherwise>
          and BATCH_NO is null
        </otherwise>
      </choose>
    </where>
    group by STATUS
    order by status
  </select>

  <!-- 查询已兑换数量 -->
  <select id="selectExchangeCount" resultType="java.lang.Long" parameterType="java.lang.Long">
    select
        count(1)
    from
        SMS_USER_COUPON
    where
        COUPON_ID = #{couponId,jdbcType=DECIMAL}
    and
        COUPON_TYPE = 0
    and
        BATCH_NO is null
  </select>

  <!-- 更新指定批次的用户持券信息数据 -->
  <update id="updateByBatchNo" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    update
    SMS_USER_COUPON
    <set>
      <if test="couponId != null">
        COUPON_ID = #{couponId,jdbcType=DECIMAL},
      </if>
      <if test="couponName != null and couponName != ''">
        COUPON_NAME = #{couponName,jdbcType=VARCHAR},
      </if>
      <if test="expireDate != null">
        EXPIRE_DATE = #{expireDate,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        STATUS = #{status,jdbcType=DECIMAL},
      </if>
      <if test="updateTime != null">
        UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP}
      </if>
    </set>
    where BATCH_NO = #{batchNo,jdbcType=VARCHAR} and STATUS != 1
  </update>

  <!-- 根据批次号查询该批次用户使用券数量(按使用券状态分组) -->
  <select id="selectCountByBatchNo" resultType="java.util.HashMap" parameterType="java.lang.String">
    select
        COUNT(1) as quantity,
        STATUS as status
    from
        SMS_USER_COUPON
    where
        BATCH_NO = #{batchNo,jdbcType=VARCHAR} and STATUS in(1,2)
    group by STATUS
    order by STATUS
  </select>

  <!-- 查询用户优惠券使用信息列表 -->
  <select id="selectUserCouponList" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO" resultType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    select
      suc.USER_COUPON_ID as userCouponId,
      suc.CUST_NO as custNo,
      suc.BATCH_NO as batchNo,
      suc.ORDER_SN as orderSn,
      suc.COUPON_NAME couponName,
      suc.COUPON_TYPE couponType,
      suc.COUPON_ID as couponId,
      suc.STATUS,
      suc.CREATE_TIME as createTime,
      suc.UPDATE_TIME as updateTime,
      suc.EXPIRE_DATE as expireDate,
      sc.START_TIME as startTime,
      sc.END_TIME as endTime,
      sc.SEND_TIME as sendTime,
      sc.SUB_ACTIVITY_ID as subActivityId,
      sc.COUPON_AMOUNT as couponAmount
    from
    sms_user_coupon suc
    left join sms_coupon sc on suc.BATCH_NO = sc.BATCH_NO
    left join oms_order o on suc.ORDER_SN = o.ORDER_SN
    <where>
      <if test="custNo != null and custNo != ''">
        and suc.CUST_NO = #{custNo,jdbcType=VARCHAR}
      </if>
      <if test="couponType != null">
        and suc.COUPON_TYPE = #{couponType,jdbcType=DECIMAL}
      </if>
      <if test="status != null">
        and suc.STATUS = #{status,jdbcType=DECIMAL}
      </if>
      <if test="startSendTime != null">
        and suc.CREATE_TIME &gt;= #{startSendTime,jdbcType=TIMESTAMP}
      </if>
      <if test="endSendTime != null">
        and suc.CREATE_TIME &lt;= #{endSendTime,jdbcType=TIMESTAMP}
      </if>
      <if test="batchNo != null and batchNo != ''">
        and (suc.BATCH_NO like '%' || #{batchNo,jdbcType=VARCHAR} || '%' or suc.ORDER_SN like '%' || #{batchNo,jdbcType=VARCHAR} || '%')
      </if>
      <if test="couponName != null and couponName != ''">
        and suc.COUPON_NAME like '%' || #{couponName,jdbcType=VARCHAR} || '%'
      </if>
      and suc.STATUS <![CDATA[<>]]> -1
    </where>
    order by suc.CREATE_TIME desc
  </select>

  <!-- 根据优惠券批次号查询用户持券数量 -->
  <select id="selectCouponCountByBatchNo" resultType="java.lang.Long" parameterType="java.lang.String">
    select
        count(1)
    from
        SMS_USER_COUPON
    where
        BATCH_NO = #{batchNo,jdbcType=VARCHAR}
  </select>

  <!-- 查询核销订单信息 -->
  <select id="selectWriteOffOrderInfo" parameterType="java.lang.Long" resultType="com.qdbank.mall.model.usercoupon.UserCouponDO">
      select
        *
      from
      (
        select
          ORDER_SN as writeOffOrderSn,
          ORDER_ID as orderId,
          PRODUCT_TYPE as productType
        from OMS_ORDER
        <where>
          <if test="userCouponId != null">
            and USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
          </if>
        </where>
        order by UPDATE_TIME desc
      )
      where ROWNUM = 1
  </select>

  <!-- 批量更新用户持券数据为作废 -->
  <update id="updateUserCouponInvalidByCouponId" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    update
    SMS_USER_COUPON
    <set>
      <if test="status != null">
        STATUS = #{status,jdbcType=DECIMAL},
      </if>
      <if test="updateTime != null">
        UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP}
      </if>
    </set>
    where
      COUPON_ID = #{couponId,jdbcType=DECIMAL} and status not in (1,3)
  </update>

  <!-- 批量更新用户持券数据为作废 -->
  <update id="updateUserCouponInvalidByBatchNo" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO">
    update
      SMS_USER_COUPON
    <set>
      <if test="status != null">
        STATUS = #{status,jdbcType=DECIMAL},
      </if>
      <if test="updateTime != null">
        UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP}
      </if>
    </set>
    where BATCH_NO = #{batchNo,jdbcType=VARCHAR} and STATUS not in (1,3)
  </update>

  <!-- 根据客户号查询指定专区现金优惠券列表 -->
  <select id="selectPrefectureUserCouponList" parameterType="com.qdbank.mall.model.usercoupon.UserCouponDO" resultType="com.qdbank.mall.model.usercoupon.UserCouponDetailDO">
    select
      suc.USER_COUPON_ID as userCouponId,
      suc.COUPON_NAME couponName,
      suc.COUPON_ID as couponId,
      sc.PREFECTURE_ID as prefectureId,
      sc.COUPON_AMOUNT as couponAmount
    from
    sms_user_coupon suc
    left join sms_coupon sc on suc.BATCH_NO = sc.BATCH_NO
    <where>
      <if test="custNo != null and custNo != ''">
        and suc.CUST_NO = #{custNo,jdbcType=VARCHAR}
      </if>
      <if test="couponType != null">
        and suc.COUPON_TYPE = #{couponType,jdbcType=DECIMAL}
      </if>
      <if test="status != null">
        and suc.STATUS = #{status,jdbcType=DECIMAL}
      </if>
    </where>
  </select>

  <!-- 批量更新用户持券数据为作废 -->
  <update id="updateExpireUserCoupon">
    update SMS_USER_COUPON t set status = 2,UPDATE_TIME = sysdate
      <where>
          t.STATUS = 0
          <if test="couponType != null">
            and t.COUPON_TYPE = #{couponType}
          </if>
          <if test="startDate != null">
            and t.expire_date &gt; #{startDate,jdbcType=TIMESTAMP}
          </if>
          <if test="endDate != null">
            and t.expire_date &lt; #{endDate,jdbcType=TIMESTAMP}
          </if>
      </where>
    </update>


  <select id="queryExpireUserCoupon" resultMap="BaseResultMap">
    select
        <include refid="Base_Column_List" />
    from
      SMS_USER_COUPON t
    <where>
      t.STATUS = 2
      <if test="couponType != null">
        and t.COUPON_TYPE = #{couponType}
      </if>
      <if test="startDate != null">
        and t.expire_date &gt; #{startDate,jdbcType=TIMESTAMP}
      </if>
      <if test="endDate != null">
        and t.expire_date &lt; #{endDate,jdbcType=TIMESTAMP}
      </if>
    </where>
  </select>

  <!-- 查询所有用户优惠券待使用信息列表 -->
  <select id="selectHistoryUserCouponList" resultType="com.qdbank.mall.model.usercoupon.UserCouponDetailDO">
    select
    suc.USER_COUPON_ID as userCouponId,
    suc.CUST_NO as custNo,
    suc.BATCH_NO as batchNo,
    suc.ORDER_SN as orderSn,
    suc.COUPON_NAME couponName,
    suc.COUPON_TYPE couponType,
    suc.COUPON_ID as couponId,
    suc.STATUS,
    suc.CREATE_TIME as createTime,
    suc.UPDATE_TIME as updateTime,
    suc.EXPIRE_DATE as expireDate,
    sc.START_TIME as startTime,
    sc.END_TIME as endTime,
    sc.SEND_TIME as sendTime,
    sc.SUB_ACTIVITY_ID as subActivityId,
    sc.product_type as productType,
    sc.coupon_amount as couponAmount,
    sc.coupon_description as couponDescription
    from
        sms_user_coupon suc
    left join
        sms_coupon sc on suc.COUPON_ID = sc.COUPON_ID
    where
        suc.STATUS = 0
  </select>


  <select id="selecUserCouponDetailById" resultType="com.qdbank.mall.model.usercoupon.UserCouponDetailDO">
    select
    suc.USER_COUPON_ID as userCouponId,
    suc.CUST_NO as custNo,
    suc.BATCH_NO as batchNo,
    suc.ORDER_SN as orderSn,
    suc.COUPON_NAME couponName,
    suc.COUPON_TYPE couponType,
    suc.COUPON_ID as couponId,
    suc.STATUS,
    suc.CREATE_TIME as createTime,
    suc.UPDATE_TIME as updateTime,
    suc.EXPIRE_DATE as expireDate,
    sc.START_TIME as startTime,
    sc.END_TIME as endTime,
    sc.SEND_TIME as sendTime,
    sc.SUB_ACTIVITY_ID as subActivityId,
    sc.product_type as productType,
    sc.coupon_amount as couponAmount,
    sc.coupon_description as couponDescription
    from
        sms_user_coupon suc
    left join
        sms_coupon sc on suc.COUPON_ID = sc.COUPON_ID
    where
        suc.USER_COUPON_ID = #{userCouponId,jdbcType=DECIMAL}
  </select>


  <select id="selectCouponList"  resultMap="couponResultMap">
    select
    s.product_integration,
    s.coupon_amount,
    s.coupon_description,
    s.product_status,
    s.batch_status,
    s.product_type,
    s.product_id,
    s.product_name,
    s.product_sku_id,
    s.expire_days,
    s.prefecture_id,
    s.main_activity_id,
    s.sub_activity_id,
    u.expire_date,
    s.send_time,
    u.user_coupon_id,
    u.coupon_type,
    u.order_sn,
    u.coupon_id,
    u.order_integration,
    s.coupon_name,
    u.status,
    u.batch_no,
    s.distribute_way,
    s.start_time,
    s.end_time,
    u.create_time
    from
    SMS_USER_COUPON u,SMS_COUPON s
    where
    u.COUPON_ID = s.COUPON_ID
    and u.STATUS = #{status,jdbcType=DECIMAL}
    and u.CUST_NO = #{custNo,jdbcType=VARCHAR}
    <if test="startTime != null">
      and u.UPDATE_TIME &gt; #{startTime,jdbcType=TIMESTAMP}
    </if>
    <if test="endTime != null">
      and u.UPDATE_TIME &lt; #{endTime,jdbcType=TIMESTAMP}
    </if>
    order by u.UPDATE_TIME desc
  </select>

  <!-- 查询指定时间段即将过期的(名单文件发放)优惠券信息 -->
  <select id="selectFileExpiringCoupon" resultType="com.qdbank.mall.model.usercoupon.UserCouponDetailDO">
    select
      suc.USER_COUPON_ID as userCouponId,
      suc.CUST_NO as custNo,
      suc.COUPON_NAME couponName,
      sc.END_TIME as expireDate,
      sc.coupon_amount as couponAmount
    from
      sms_user_coupon suc
    left join sms_coupon sc on suc.COUPON_ID = sc.COUPON_ID
    <where>
      suc.STATUS = 0 and sc.DISTRIBUTE_WAY = 1 and sc.SUB_ACTIVITY_ID is null
      <if test="endDate != null">
        and to_char(sc.end_time,'yyyy-MM-dd') = to_char(#{endDate,jdbcType=TIMESTAMP},'yyyy-MM-dd')
      </if>
    </where>
  </select>

  <!-- 查询指定时间段即将过期的(北斗发放)优惠券信息 -->
  <select id="selectBeidouExpiringCoupon" resultType="com.qdbank.mall.model.usercoupon.UserCouponDetailDO">
    select
      suc.USER_COUPON_ID as userCouponId,
      suc.CUST_NO as custNo,
      suc.COUPON_NAME couponName,
      suc.EXPIRE_DATE as expireDate,
      sc.coupon_amount as couponAmount
    from
      sms_user_coupon suc
    left join sms_coupon sc on suc.COUPON_ID = sc.COUPON_ID
    <where>
      suc.STATUS = 0 and sc.DISTRIBUTE_WAY = 1 and sc.SUB_ACTIVITY_ID is not null and suc.COUPON_TYPE in(0,4)
      <if test="endDate != null">
        and to_char(suc.EXPIRE_DATE,'yyyy-MM-dd') = to_char(#{endDate,jdbcType=TIMESTAMP},'yyyy-MM-dd')
      </if>
    </where>
  </select>

  <!-- 查询指定时间段即将过期的(自行兑换积分兑换券)优惠券信息 -->
  <select id="selectSelfExchangeExpiringCoupon" resultType="com.qdbank.mall.model.usercoupon.UserCouponDetailDO">
    select
      suc.USER_COUPON_ID as userCouponId,
      suc.CUST_NO as custNo,
      suc.COUPON_NAME couponName,
      suc.EXPIRE_DATE as expireDate,
      sc.coupon_amount as couponAmount
    from
      sms_user_coupon suc
    left join sms_coupon sc on suc.COUPON_ID = sc.COUPON_ID
    <where>
      suc.STATUS = 0 and sc.DISTRIBUTE_WAY = 0 and suc.COUPON_TYPE = 0 and sc.SUB_ACTIVITY_ID is null
      <if test="endDate != null">
        and to_char(suc.EXPIRE_DATE,'yyyy-MM-dd') = to_char(#{endDate,jdbcType=TIMESTAMP},'yyyy-MM-dd')
      </if>
    </where>
  </select>

</mapper>